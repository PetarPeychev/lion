<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lion - Concatenative Programming Language</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Courier New', monospace;
            background: #1e1e1e;
            color: #ffffff;
            height: 100vh;
            font-size: 16px;
            display: flex;
            flex-direction: column;
        }

        header {
            background-color: #333;
            color: white;
            padding: 1rem;
            text-align: center;
            margin-bottom: 1rem;
        }

        .container {
            display: flex;
            flex: 1;
            overflow: hidden;
            margin-bottom: 1rem;
        }

        .sidebar {
            background-color: #2a2a2a;
            padding: 1rem;
            overflow-y: auto;
        }

        .stack-item {
            background-color: #3a3a3a;
            border: 1px solid #555;
            padding: 0.5rem;
            margin-bottom: 0.5rem;
            border-radius: 4px;
        }

        .binding {
            background-color: #3a3a3a;
            border: 1px solid #555;
            padding: 0.5rem;
            margin-bottom: 0.5rem;
            border-radius: 4px;
        }

        .binding-name {
            font-weight: bold;
        }

        .sidebar-left {
            width: 20%;
            border-right: 1px solid #444;
            margin-right: 1rem;
        }

        .sidebar-right {
            width: 20%;
            border-left: 1px solid #444;
            margin-left: 1rem;
        }

        .main {
            width: 60%;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .editor {
            flex: 3;
            background-color: #2a2a2a;
            color: #d4d4d4;
            border: 1px solid #444;
            font-family: 'Courier New', monospace;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .editor-menu {
            background-color: #2a2a2a;
            border-bottom: 1px solid #444;
            padding: 0.3rem 0.5rem;
            display: flex;
            justify-content: flex-end;
            gap: 0.5rem;
        }

        .editor-menu button {
            background-color: #3a3a3a;
            color: #d4d4d4;
            border: 1px solid #555;
            border-radius: 3px;
            padding: 0.25rem 0.5rem;
            cursor: pointer;
            font-size: 16px;
            display: inline-block;
        }

        .editor-menu button:hover {
            background-color: #4a4a4a;
        }

        .editor-menu button:active {
            background-color: #555;
        }

        .editor textarea {
            width: 100%;
            flex: 1;
            background-color: #1e1e1e;
            color: #d4d4d4;
            border: none;
            outline: none;
            resize: none;
            font-family: 'Courier New', monospace;
            font-size: 16px;
            padding: 1rem;
            overflow: auto;
        }

        .repl {
            flex: 1;
            background-color: #2a2a2a;
            color: #d4d4d4;
            border: 1px solid #444;
            font-family: 'Courier New', monospace;
            display: flex;
            flex-direction: column;
        }

        .repl-history {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            padding-bottom: 0.5rem;
        }

        .repl-input-line {
            background-color: #1e1e1e;
            border-top: 1px solid #444;
            padding: 0.5rem 1rem;
            display: flex;
            align-items: center;
        }

        .repl-prompt {
            color: #d4d4d4;
            margin-right: 0.5rem;
        }

        .repl-input {
            flex: 1;
            background-color: transparent;
            color: #d4d4d4;
            border: none;
            outline: none;
            font-family: 'Courier New', monospace;
            font-size: 16px;
        }
    </style>
</head>
<body>
    <header>
        <h1>Lion</h1>
    </header>

    <div class="container">
        <aside class="sidebar sidebar-left">
        </aside>

        <main class="main">
            <div class="editor">
                <div class="editor-menu">
                    <button id="run-btn" title="Clear state and run code.">â–¶</button>
                </div>
                <textarea></textarea>
            </div>

            <div class="repl">
                <div class="repl-history"></div>
                <div class="repl-input-line">
                    <span class="repl-prompt">></span>
                    <input type="text" class="repl-input">
                </div>
            </div>
        </main>

        <aside class="sidebar sidebar-right">
        </aside>
    </div>

    <script>
        class Symbol {
            constructor(name) {
                this.name = name;
            }
        }

        function s(name) {
            return new Symbol(name);
        }

        const stack = [];
        const envStack = [{}];

        function valueToString(value) {
            if (value instanceof Symbol) {
                return value.name;
            } else if (typeof value === 'string') {
                return `"${value}"`;
            } else if (typeof value === 'boolean') {
                return value ? 'true' : 'false';
            } else if (typeof value === 'number') {
                return String(value);
            } else if (Array.isArray(value)) {
                return `[${value.map(valueToString).join(' ')}]`;
            }
            return String(value);
        }

        function push(value) {
            stack.push(value);
            const stackList = document.querySelector('.sidebar-left');
            const stackItem = document.createElement('div');
            stackItem.className = 'stack-item';
            stackItem.textContent = valueToString(value);
            stackList.insertBefore(stackItem, stackList.firstChild);
        }

        function pop() {
            const value = stack.pop();
            const stackList = document.querySelector('.sidebar-left');
            if (stackList.firstChild) stackList.removeChild(stackList.firstChild);
            return value;
        }

        function bindName(name, value) {
            const topEnv = envStack[envStack.length - 1];
            topEnv[name] = value;
            const bindingsList = document.querySelector('.sidebar-right');
            const binding = document.createElement('div');
            binding.className = 'binding';
            const nameDiv = document.createElement('div');
            const nameSpan = document.createElement('span');
            nameSpan.className = 'binding-name';
            nameSpan.textContent = name;
            nameDiv.appendChild(nameSpan);
            const valueDiv = document.createElement('div');
            if (value instanceof Function) {
                valueDiv.textContent = value.description;
            } else {
                valueDiv.textContent = value.map(valueToString).join(' ');
            }
            binding.appendChild(nameDiv);
            binding.appendChild(valueDiv);
            bindingsList.insertBefore(binding, bindingsList.firstChild);
        }

        function clearAndRun() {
            stack.length = 0;
            document.querySelector('.sidebar-left').innerHTML = '';

            envStack.length = 0;
            envStack.push({});
            document.querySelector('.sidebar-right').innerHTML = '';

            document.querySelector('.repl-history').innerHTML = '';

            addBuiltins();
        }

        document.getElementById('run-btn').addEventListener('click', clearAndRun);

        function parse(code) {
            const result = [];
            let i = 0;

            while (i < code.length) {
                while (i < code.length && (code[i] === ' ' || code[i] === '\t' || code[i] === '\n' || code[i] === '\r')) {
                    i++;
                }

                if (i >= code.length) break;

                if (code[i] === '(') {
                    let depth = 1;
                    i++;
                    while (i < code.length && depth > 0) {
                        if (code[i] === '(') depth++;
                        if (code[i] === ')') depth--;
                        i++;
                    }
                    if (depth > 0) throw new Error('unterminated quoted expression: missing closing parenthesis');
                    continue;
                }

                if (code[i] === ')') {
                    throw new Error("unexpected closing parenthesis ')' without matching opening parenthesis");
                }

                if (code[i] === '"') {
                    i++;
                    const start = i;
                    while (i < code.length && code[i] !== '"') {
                        if (code[i] === '\\') {
                            if (i + 1 >= code.length) {
                                throw new Error('unterminated string: escape sequence at end of input');
                            }
                            i += 2;
                        } else {
                            i++;
                        }
                    }
                    if (i >= code.length) throw new Error('unterminated string: missing closing quote');
                    result.push(code.substring(start, i));
                    i++;
                    continue;
                }

                if (code[i] === '[') {
                    i++;
                    const start = i;
                    let depth = 1;
                    while (i < code.length && depth > 0) {
                        if (code[i] === '[') depth++;
                        if (code[i] === ']') depth--;
                        i++;
                    }
                    if (depth > 0) throw new Error("unterminated quoted expression: missing closing bracket ']'");
                    result.push(parse(code.substring(start, i - 1)));
                    continue;
                }

                if (code[i] === ']') {
                    throw new Error("unexpected closing bracket ']' without matching opening bracket");
                }

                const start = i;
                while (i < code.length && code[i] !== ' ' && code[i] !== '\t' && code[i] !== '\n' && code[i] !== '\r' &&
                       code[i] !== '(' && code[i] !== ')' && code[i] !== '[' && code[i] !== ']' && code[i] !== '"') {
                    i++;
                }

                const token = code.substring(start, i);
                if (token === '') continue;

                const num = parseFloat(token);
                if (!isNaN(num)) {
                    result.push(num);
                    continue;
                }

                if (token === 'true') {
                    result.push(true);
                    continue;
                }
                if (token === 'false') {
                    result.push(false);
                    continue;
                }

                result.push(new Symbol(token));
            }

            return result;
        }

        function apply(values) {
            for (const v of values) {
                if (Array.isArray(v)) {
                    push(v);
                } else if (typeof v === 'number') {
                    push(v);
                } else if (typeof v === 'boolean') {
                    push(v);
                } else if (typeof v === 'string') {
                    push(v);
                } else if (v instanceof Symbol) {
                    let found = false;
                    for (let i = envStack.length - 1; i >= 0; i--) {
                        if (v.name in envStack[i]) {
                            const value = envStack[i][v.name];
                            if (typeof value === 'function') {
                                value();
                            } else {
                                value.map(v => {
                                    if (Array.isArray(v)) {
                                        apply(v);
                                    } else {
                                        apply([v]);
                                    }
                                });
                            }
                            found = true;
                            break;
                        }
                    }
                    if (!found) {
                        throw new Error(`undefined symbol '${v.name}'`);
                    }
                }
            }
        }

        function call(quote) {
            const bindingsList = document.querySelector('.sidebar-right');
            const initialBindingsCount = bindingsList.children.length;
            envStack.push({});
            apply(quote);
            envStack.pop();
            while (bindingsList.children.length > initialBindingsCount) {
                bindingsList.removeChild(bindingsList.firstChild);
            }
        }

        function annotate(f, description) {
            f.description = description;
            return f;
        }

        function addBuiltins() {
            bindName('apply', annotate(() => apply(pop()), 'apply a quote to the current environment'));
            bindName('call', annotate(() => call(pop()), 'call a quote in a new environment'));
            bindName('parse', annotate(() => push(parse(pop())), 'parse a lion string to a quote'));
            bindName('bind', annotate(() => {
                const names = pop();
                for (let i = names.length - 1; i >= 0; i--) {
                    const name = names[i];
                    if (!(name instanceof Symbol)) {
                        throw new Error('Error: first argument to \'bind\' must be a quote of symbols');
                    }
                    bindName(name.name, [pop()]);
                }
            }, 'bind the top values on the stack to a quote of names'));
            bindName('swap', [[[[s('x'), s('y')], s('bind'), s('y'), s('x')]], s('call')]);
            bindName('dup', [[[[s('x')], s('bind'), s('x'), s('x')]], s('call')]);
            bindName('drop', [[[[s('x')], s('bind')]], s('call')]);
            bindName('+', annotate(() => {
                const q1 = pop();
                const q2 = pop();
                if (Array.isArray(q1) && Array.isArray(q2)) {
                    push([...q2, ...q1]);
                } else if (typeof q1 === 'string' && typeof q2 === 'string') {
                    push(q2 + q1);
                } else if (typeof q1 === 'number' && typeof q2 === 'number') {
                    push(q2 + q1);
                }
            }, 'add two numbers or concatenate two quotes/strings'));
        }

        document.querySelector('.repl-input').addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                const input = e.target.value;
                if (input.trim()) {
                    const history = document.querySelector('.repl-history');
                    const entry = document.createElement('div');
                    entry.textContent = '> ' + input;
                    history.appendChild(entry);

                    const stackCopy = [...stack];
                    const envStackCopy = envStack.map(env => ({...env}));

                    try {
                        apply(parse(input));
                    } catch (err) {
                        const errorEntry = document.createElement('div');
                        errorEntry.textContent = err.message;
                        errorEntry.style.color = '#ff6b6b';
                        history.appendChild(errorEntry);

                        stack.length = 0;
                        stack.push(...stackCopy);
                        envStack.length = 0;
                        envStack.push(...envStackCopy);

                        document.querySelector('.sidebar-left').innerHTML = '';
                        for (let i = stackCopy.length - 1; i >= 0; i--) {
                            const stackItem = document.createElement('div');
                            stackItem.className = 'stack-item';
                            stackItem.textContent = valueToString(stackCopy[i]);
                            document.querySelector('.sidebar-left').appendChild(stackItem);
                        }
                    }

                    e.target.value = '';
                    history.scrollTop = history.scrollHeight;
                }
            }
        });

        addBuiltins();

    </script>
</body>
</html>
